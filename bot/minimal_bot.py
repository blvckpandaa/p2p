# D:\oxiri-p2p\bot\bot.py

import os
import sys

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) Ğ’ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ñ€ĞµĞ½ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (D:\oxiri-p2p) Ğ² sys.path, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Python Ğ²Ğ¸Ğ´ĞµĞ» cryptofarm.settings
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PROJECT_ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), os.pardir))
if PROJECT_ROOT not in sys.path:
    sys.path.insert(0, PROJECT_ROOT)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Djangoâ€Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "cryptofarm.settings")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Django (django.setup()), Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ORM Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import django
django.setup()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from users.models import User as TelegramUser

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ Ğ´Ğ»Ñ Ğ±Ğ¾Ñ‚Ğ°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import requests
import time
import logging
import json

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ· config.py
from bot.config import BOT_TOKEN, WEBAPP_URL

# Ğ¢Ğ¾ĞºĞµĞ½ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ°
TOKEN = BOT_TOKEN
API_URL = f"https://api.telegram.org/bot{TOKEN}"

# URL WebApp (Ğ²Ğ°Ñˆ HTTPSâ€Ğ´Ğ¾Ğ¼ĞµĞ½, Ğ½Ğ° ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Django-Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ñ€)
WEBAPP_URL_BASE = f"{WEBAPP_URL}/telegram_login"

last_update_id = 0

def get_updates():
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Telegram, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ long polling (getUpdates).
    """
    global last_update_id
    params = {
        "offset": last_update_id + 1,
        "timeout": 30,
        "allowed_updates": ["message", "callback_query"]
    }
    try:
        logger.info(f"Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°Ñ getUpdates Ñ offset={params['offset']}")
        resp = requests.get(f"{API_URL}/getUpdates", params=params, timeout=35)
        if resp.status_code == 200:
            data = resp.json()
            if data.get("ok"):
                results = data.get("result", [])
                if results:
                    last_update_id = results[-1]["update_id"]
                logger.info(f"ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹: {len(results)}")
                return results
            else:
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° API getUpdates: {data}")
        else:
            logger.error(f"HTTP {resp.status_code} Ğ½Ğ° getUpdates: {resp.text}")
    except Exception as e:
        logger.error(f"Ğ˜ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ getUpdates: {e}")
    return []

def send_message(chat_id, text, reply_markup=None):
    """
    ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ chat_id Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ text. Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ reply_markup â€” ÑƒĞ¿Ğ°ĞºĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ ĞµĞ³Ğ¾ ĞºĞ°Ğº JSON.
    """
    params = {
        "chat_id": chat_id,
        "text": text,
        "parse_mode": "HTML"
    }
    if reply_markup:
        params["reply_markup"] = json.dumps(reply_markup)
    try:
        logger.info(f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² Ñ‡Ğ°Ñ‚ {chat_id}")
        resp = requests.post(f"{API_URL}/sendMessage", json=params)
        result = resp.json()
        if not result.get("ok"):
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° sendMessage: {result}")
        return result
    except Exception as e:
        logger.error(f"Ğ˜ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ sendMessage: {e}")
        return {"ok": False, "error": str(e)}

def handle_message(message):
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    - /start: ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ‘Ğ” Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ WebAppâ€ĞºĞ½Ğ¾Ğ¿ĞºÑƒ.
    - /help: ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ°.
    - /play: Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ÑˆĞ»Ñ‘Ğ¼ Ñ‚Ñƒ Ğ¶Ğµ WebAppâ€ĞºĞ½Ğ¾Ğ¿ĞºÑƒ.
    - /ref: Ğ²Ñ‹Ğ´Ğ°Ñ‘Ğ¼ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ (tg_id + ?ref=).
    - Ğ¸Ğ½Ğ°Ñ‡Ğµ: Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ WebAppâ€ĞºĞ½Ğ¾Ğ¿ĞºÑƒ.
    """
    chat_id   = message["chat"]["id"]
    text      = message.get("text", "")
    user_info = message.get("from", {})
    telegram_id = user_info.get("id")
    first_name = user_info.get("first_name", "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ")

    logger.info(f"ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: {text} Ğ¾Ñ‚ ID={telegram_id} ({first_name})")

    if text == "/start":
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 5.1) Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ TelegramUser Ğ² Ğ‘Ğ”
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try:
            tg_user, created = TelegramUser.objects.get_or_create(
                telegram_id=telegram_id,
                defaults={
                    "username":    user_info.get("username") or "",
                    "first_name":  first_name,
                    "last_name":   user_info.get("last_name") or "",
                    "photo_url":   user_info.get("photo_url") or "",
                    "cf_balance":  0,    # ĞµÑĞ»Ğ¸ Ñƒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ default=0, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ
                    "ton_balance": 0,    # ĞµÑĞ»Ğ¸ Ñƒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ default=0, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ
                }
            )
            if not created:
                # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»Ñ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¼ Ğ²Ñ…Ğ¾Ğ´Ğµ
                tg_user.username   = user_info.get("username") or ""
                tg_user.first_name = first_name
                tg_user.last_name  = user_info.get("last_name") or ""
                tg_user.photo_url  = user_info.get("photo_url") or ""
                tg_user.save()
        except Exception as e:
            logger.error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ User: {e}")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 5.2) Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ WebAppâ€URL: https://â€¦/?tg_id=<ID>
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        webapp_url = f"{WEBAPP_URL_BASE}?tg_id={telegram_id}"

        welcome_text = (
            f"ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {first_name}! ğŸ‘‹\n\n"
            "Ğ’Ğ°ÑˆĞ° ÑƒÑ‡Ñ‘Ñ‚Ğ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°.\n"
            "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ."
        )
        webapp_button = {
            "inline_keyboard": [
                [
                    {
                        "text": "ğŸŒ± Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ",
                        "web_app": {"url": webapp_url}
                    }
                ]
            ]
        }
        send_message(chat_id, welcome_text, webapp_button)

    elif text == "/help":
        help_text = (
            "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n"
            "/start â€” Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ\n"
            "/help  â€” ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ\n"
            "/ref   â€” ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ"
        )
        send_message(chat_id, help_text)

    elif text == "/play":
        # Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ÑˆĞ»Ñ‘Ğ¼ WebAppâ€ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
        webapp_url = f"{WEBAPP_URL_BASE}?tg_id={telegram_id}"
        play_text = "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ:"
        webapp_button = {
            "inline_keyboard": [
                [
                    {
                        "text": "ğŸŒ± Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ",
                        "web_app": {"url": webapp_url}
                    }
                ]
            ]
        }
        send_message(chat_id, play_text, webapp_button)

    elif text == "/ref":
        # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ: /?tg_id=<ID>&ref=<ID>
        ref_url = f"{WEBAPP_URL_BASE}?tg_id={telegram_id}&ref={telegram_id}"
        ref_text = (
            f"Ğ’Ğ°ÑˆĞ° Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ°:\n{ref_url}\n\n"
            "ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ ĞµÑ Ñ Ğ´Ñ€ÑƒĞ·ÑŒÑĞ¼Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ğ½ÑƒÑÑ‹!"
        )
        ref_buttons = {
            "inline_keyboard": [
                [
                    {"text": "ğŸ”— ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ·ĞµĞ¹", "url": ref_url}
                ],
                [
                    {
                        "text": "ğŸŒ± Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ",
                        "web_app": {"url": ref_url}
                    }
                ]
            ]
        }
        send_message(chat_id, ref_text, ref_buttons)

    else:
        # Ğ›ÑĞ±Ğ¾Ğ¹ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ñ‚ĞµĞºÑÑ‚ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ WebAppâ€ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
        webapp_url = f"{WEBAPP_URL_BASE}?tg_id={telegram_id}"
        play_text = "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /help Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ:"
        webapp_button = {
            "inline_keyboard": [
                [
                    {
                        "text": "ğŸŒ± Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ",
                        "web_app": {"url": webapp_url}
                    }
                ]
            ]
        }
        send_message(chat_id, play_text, webapp_button)

if __name__ == "__main__":
    logger.info(f"Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°. Token={TOKEN[:5]}â€¦, WebApp: {WEBAPP_URL_BASE}")

    # Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ webhook (ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ±Ñ‹Ğ» Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½)
    try:
        requests.get(f"{API_URL}/deleteWebhook?drop_pending_updates=true")
    except Exception as e:
        logger.error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ webhook: {e}")

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½Ğ°
    try:
        me = requests.get(f"{API_URL}/getMe").json()
        if me.get("ok"):
            logger.info(f"Ğ‘Ğ¾Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ ĞºĞ°Ğº @{me['result']['username']}")
        else:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ°: {me}")
    except Exception as e:
        logger.error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½: {e}")

    # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ†Ğ¸ĞºĞ» getUpdates
    while True:
        try:
            updates = get_updates()
            for update in updates:
                if "message" in update:
                    handle_message(update["message"])
            time.sleep(1)
        except KeyboardInterrupt:
            logger.info("Ğ‘Ğ¾Ñ‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ.")
            break
        except Exception as e:
            logger.error(f"Ğ˜ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ² Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¼ Ñ†Ğ¸ĞºĞ»Ğµ: {e}")
            time.sleep(5)
