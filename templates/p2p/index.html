{% extends 'base.html' %}

{% block title %}Oxiri P2P - Обмен{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/p2p.css">
<script src="/static/js/p2p.js"></script>
{% endblock %}

{% block content %}
<div class="py-6">
    <!-- Заголовок и кнопки переключения -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-bold">P2P Обмен</h1>
        <div class="flex space-x-2">
            <a href="?action=buy" class="px-4 py-2 rounded-lg {% if action == 'buy' or not action %}bg-accent text-dark{% else %}bg-primary/30{% endif %}">
                Купить
            </a>
            <a href="?action=sell" class="px-4 py-2 rounded-lg {% if action == 'sell' %}bg-accent text-dark{% else %}bg-primary/30{% endif %}">
                Продать
            </a>
        </div>
    </div>
    
    <!-- Выбор криптовалюты -->
    <div class="mb-6">
        <div class="grid grid-cols-3 gap-2">
            <a href="?action={{ action }}&crypto=cf" class="text-center py-3 rounded-lg {% if crypto == 'cf' or not crypto %}bg-primary/50{% else %}bg-primary/30{% endif %}">
                CF
            </a>
            <a href="?action={{ action }}&crypto=ton" class="text-center py-3 rounded-lg {% if crypto == 'ton' %}bg-primary/50{% else %}bg-primary/30{% endif %}">
                TON
            </a>
            <a href="?action={{ action }}&crypto=not" class="text-center py-3 rounded-lg {% if crypto == 'not' %}bg-primary/50{% else %}bg-primary/30{% endif %}">
                NOT
            </a>
        </div>
    </div>
    
    <!-- Фильтры и сортировка -->
    <div class="filter-section mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="filter-price" class="filter-label">Максимальная цена</label>
                <input type="number" id="filter-price" class="filter-input" placeholder="Любая">
            </div>
            <div>
                <label for="filter-amount" class="filter-label">Минимальная сумма</label>
                <input type="number" id="filter-amount" class="filter-input" placeholder="Любая">
            </div>
            <div>
                <label for="sort-orders" class="filter-label">Сортировка</label>
                <select id="sort-orders" class="sort-select">
                    <option value="price">По цене</option>
                    <option value="amount">По количеству</option>
                    <option value="date">По дате</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Форма создания ордера -->
    {% if action == 'sell' %}
    <div class="card p-4 mb-6">
        <h2 class="text-lg font-semibold mb-4">Создать ордер на продажу</h2>
        <form class="p2p-form" action="/p2p/create_order/" method="post">
            {% csrf_token %}
            <input type="hidden" name="type" value="sell">
            <input type="hidden" name="token_type" value="{{ crypto|default:'CF'|upper }}">
            
            <div class="mb-4">
                <label class="block text-sm mb-1">Количество {{ crypto|default:'CF'|upper }}</label>
                <input type="number" name="amount" class="input-field w-full" placeholder="0.00" step="0.01" min="0.01" required>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm mb-1">Цена в рублях за 1 {{ crypto|default:'CF'|upper }}</label>
                <input type="number" name="price" class="input-field w-full" placeholder="0.00" step="0.01" min="0.01" required>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm mb-1">Минимальная сумма (руб.)</label>
                <input type="number" name="min_amount" class="input-field w-full" placeholder="100" step="1" min="1" required>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm mb-1">Ваши реквизиты для оплаты</label>
                <textarea name="payment_details" class="input-field w-full" rows="3" placeholder="Номер карты или кошелька для получения оплаты" required></textarea>
            </div>
            
            <button type="submit" class="bg-accent text-dark font-semibold py-3 rounded-xl text-center w-full">
                Создать ордер
            </button>
        </form>
    </div>
    {% else %}
    <div class="card p-4 mb-6">
        <h2 class="text-lg font-semibold mb-4">Создать ордер на покупку</h2>
        <form class="p2p-form" action="/p2p/create_order/" method="post">
            {% csrf_token %}
            <input type="hidden" name="type" value="buy">
            <input type="hidden" name="token_type" value="{{ crypto|default:'CF'|upper }}">
            
            <div class="mb-4">
                <label class="block text-sm mb-1">Количество {{ crypto|default:'CF'|upper }}</label>
                <input type="number" name="amount" class="input-field w-full" placeholder="0.00" step="0.01" min="0.01" required>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm mb-1">Цена в рублях за 1 {{ crypto|default:'CF'|upper }}</label>
                <input type="number" name="price" class="input-field w-full" placeholder="0.00" step="0.01" min="0.01" required>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm mb-1">Минимальная сумма (руб.)</label>
                <input type="number" name="min_amount" class="input-field w-full" placeholder="100" step="1" min="1" required>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm mb-1">Ваши реквизиты для перевода</label>
                <textarea name="payment_details" class="input-field w-full" rows="3" placeholder="Адрес кошелька для получения криптовалюты" required></textarea>
            </div>
            
            <button type="submit" class="bg-accent text-dark font-semibold py-3 rounded-xl text-center w-full">
                Создать ордер
            </button>
        </form>
    </div>
    {% endif %}
    
    <!-- Список ордеров -->
    <div class="mb-6">
        <h2 class="text-lg font-semibold mb-4">Активные ордера</h2>
        
        <div class="orders-list">
            {% if orders %}
                {% for order in orders %}
                <div class="card p-4 mb-3 order-card {% if order.type == 'buy' %}order-buy{% else %}order-sell{% endif %}"
                     data-price="{{ order.price_per_unit }}" 
                     data-amount="{{ order.amount }}" 
                     data-min="{{ order.min_amount }}"
                     data-timestamp="{{ order.created_at|date:'U' }}">
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <span class="text-xs px-2 py-1 rounded-full {% if order.type == 'buy' %}bg-accent/20 text-accent{% else %}bg-secondary/20 text-white{% endif %}">
                                {{ order.type|upper }}
                            </span>
                            <span class="text-sm ml-2">{{ order.token_type }}</span>
                        </div>
                        <div class="text-sm">
                            <span class="status-indicator {% if order.is_active %}status-active{% else %}status-inactive{% endif %}"></span>
                            {{ order.created_at|date:"d.m.Y H:i" }}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="bg-primary/20 p-2 rounded-lg">
                            <div class="text-xs opacity-70">Количество:</div>
                            <div class="font-semibold">{{ order.amount }} {{ order.token_type }}</div>
                        </div>
                        <div class="bg-primary/20 p-2 rounded-lg">
                            <div class="text-xs opacity-70">Цена за 1 {{ order.token_type }}:</div>
                            <div class="font-semibold">{{ order.price_per_unit }} ₽</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm">
                            Мин. сумма: <span class="font-semibold">{{ order.min_amount }} ₽</span>
                        </div>
                        
                        {% if order.user.id == request.user.id %}
                        <form action="{% url 'toggle_order' %}" method="post" class="p2p-form">
                            {% csrf_token %}
                            <input type="hidden" name="order_id" value="{{ order.id }}">
                            <button type="submit" class="px-3 py-1 rounded-lg bg-primary/30 text-xs">
                                {% if order.is_active %}Деактивировать{% else %}Активировать{% endif %}
                            </button>
                        </form>
                        {% else %}
                        <a href="{% url 'order_detail' order.id %}" class="px-3 py-1 rounded-lg bg-accent text-dark text-xs">
                            {% if order.type == 'buy' %}Продать{% else %}Купить{% endif %}
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="card p-4 text-center">
                <p class="mb-4">Нет активных ордеров для {{ crypto|default:'CF'|upper }}</p>
                <p class="text-sm opacity-70">Будьте первым, кто создаст ордер!</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Мои активные сделки -->
    {% if my_deals %}
    <div class="mb-6">
        <h2 class="text-lg font-semibold mb-4">Мои активные сделки</h2>
        
        {% for deal in my_deals %}
        <div class="card p-4 mb-3">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <span class="text-xs px-2 py-1 rounded-full {% if deal.is_buyer %}bg-accent/20 text-accent{% else %}bg-secondary/20 text-white{% endif %}">
                        {% if deal.is_buyer %}ПОКУПКА{% else %}ПРОДАЖА{% endif %}
                    </span>
                    <span class="text-sm ml-2">{{ deal.order.token_type }}</span>
                </div>
                <div class="text-sm">
                    <span class="status-indicator status-pending"></span>
                    В процессе
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mb-3">
                <div class="bg-primary/20 p-2 rounded-lg">
                    <div class="text-xs opacity-70">Количество:</div>
                    <div class="font-semibold">{{ deal.amount }} {{ deal.order.token_type }}</div>
                </div>
                <div class="bg-primary/20 p-2 rounded-lg">
                    <div class="text-xs opacity-70">Сумма:</div>
                    <div class="font-semibold">{{ deal.total_price }} ₽</div>
                </div>
            </div>
            
            <a href="{% url 'deal_detail' deal.id %}" class="block w-full py-2 bg-accent text-dark text-center rounded-lg">
                Перейти к сделке
            </a>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- История транзакций -->
    <div class="mb-6">
        <h2 class="text-lg font-semibold mb-4">История сделок</h2>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr>
                        <th class="text-left p-2">Дата</th>
                        <th class="text-left p-2">Тип</th>
                        <th class="text-left p-2">Токен</th>
                        <th class="text-right p-2">Количество</th>
                        <th class="text-right p-2">Цена</th>
                        <th class="text-right p-2">Сумма</th>
                    </tr>
                </thead>
                <tbody>
                    {% if transactions %}
                        {% for tx in transactions %}
                        <tr class="border-t border-primary/20">
                            <td class="p-2">{{ tx.created_at|date:"d.m.Y H:i" }}</td>
                            <td class="p-2">
                                {% if tx.buyer == user %}
                                    <span class="text-xs px-2 py-1 rounded-full bg-accent/20 text-accent">ПОКУПКА</span>
                                {% else %}
                                    <span class="text-xs px-2 py-1 rounded-full bg-secondary/20 text-white">ПРОДАЖА</span>
                                {% endif %}
                            </td>
                            <td class="p-2">{{ tx.token_type }}</td>
                            <td class="p-2 text-right">{{ tx.amount }}</td>
                            <td class="p-2 text-right">{{ tx.price_per_unit }} ₽</td>
                            <td class="p-2 text-right">{{ tx.total_amount }} ₽</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr class="border-t border-primary/20">
                            <td colspan="6" class="p-4 text-center opacity-70">У вас пока нет завершенных сделок</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %} 