{% extends 'base.html' %}
{% load static %}

{% block title %}CryptoFarm — Мои деревья{% endblock %}

{% block content %}
<div class="py-8 max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-6 text-center">Мои деревья</h1>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {# --- CF-деревья --- #}
        {% for tree in cf_trees %}
        <div class="card p-5 relative">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-semibold">CF-Дерево</h2>
                <span class="bg-primary/30 text-white px-3 py-1 rounded-full text-sm">
                    Уровень {{ tree.level }}
                </span>
            </div>

            <div class="tree-container mb-4">
                <img src="/static/images/tree_{{ tree.level }}.png"
                     alt="CF Tree"
                     class="tree-image animate-float">
            </div>

            <div class="space-y-2 mb-6">
                <div class="flex justify-between">
                    <span>Доход:</span>
                    <span class="font-medium">{{ tree.income_per_hour }} CF/час</span>
                </div>
                <div class="flex justify-between">
                    <span>Статус:</span>
                    <span class="font-medium">
                        {% if tree.is_watered %}
                            <span class="status-indicator status-active"></span>Активно
                        {% else %}
                            <span class="status-indicator status-inactive"></span>Нужен полив
                        {% endif %}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span>Веток собрано:</span>
                    <span class="font-medium">{{ tree.branches_collected }}</span>
                </div>
            </div>

            <div class="flex justify-center">
                <a href="{% url 'tree_detail' tree.id %}"
                   class="bg-accent text-dark py-2 px-4 rounded-lg hover:bg-accent/80 transition">
                    Управление
                </a>
            </div>
        </div>
        {% endfor %}

        {# --- TON-деревья --- #}
        <div class="card p-5 relative mt-6">
    {% if ton_trees|length == 0 %}
        {# Нет TON-дерева — показываем замок, размыто и кнопку #}
        <div class="absolute inset-0 flex flex-col items-center justify-center z-10 bg-black/40 rounded-lg backdrop-blur-md">
            <img src="{% static 'images/locked.png' %}" alt="lock" class="mx-auto mb-2" style="width: 80px; height: 80px;">
            <div class="text-lg font-bold text-white mb-2">TON-дерево заблокировано</div>
            <form action="{% url 'shop:buy_ton_tree' %}" method="post">
                {% csrf_token %}
                <button type="submit"
                        class="bg-blue-500 text-white py-2 px-6 rounded-full font-semibold hover:bg-blue-600 transition">
                    Купить за {{ ton_tree_price|default:"1" }} TON
                </button>
            </form>
        </div>
        <div class="opacity-30 select-none pointer-events-none">
            <div class="tree-container mb-4">
                <img src="{% static 'images/tree_1.png' %}" alt="TON Tree" class="tree-image animate-float">
            </div>
            <div class="text-center text-white font-semibold mb-2">TON-Дерево</div>
            <div class="text-center text-white opacity-70">Получите доступ к новым возможностям!</div>
        </div>
    {% else %}
        {# Обычная карточка TON-дерева, если оно уже куплено #}
        {% for tree in ton_trees %}
        <div class="tree-container mb-4">
            <img src="/static/images/tree_{{ tree.level }}.png"
                 alt="TON Tree"
                 class="tree-image animate-float">
        </div>
        <div class="space-y-2 mb-6">
            <div class="flex justify-between">
                <span>Доход (на активную раздачу):</span>
                <span class="font-medium">
                    {{ tree.get_current_income }} TON/час
                </span>
            </div>
            <div class="flex justify-between">
                <span>Статус:</span>
                <span class="font-medium">
                    {% if tree.is_watered %}
                        <span class="status-indicator status-active"></span>Активно
                    {% else %}
                        <span class="status-indicator status-inactive"></span>Нужен полив
                    {% endif %}
                </span>
            </div>
            <div class="flex justify-between">
                <span>Веток собрано:</span>
                <span class="font-medium">{{ tree.branches_collected }}</span>
            </div>
        </div>
        <div class="flex justify-center">
            <a href="{% url 'tree_detail' tree.id %}"
               class="bg-accent text-dark py-2 px-4 rounded-lg hover:bg-accent/80 transition">
                Управление
            </a>
        </div>
        {% endfor %}
    {% endif %}
</div>

        {# Если у пользователя вообще нет деревьев (этот блок увидит только новичок) #}
        {% if cf_trees|length == 0 and ton_trees|length == 0 %}
        <div class="card p-6 col-span-full text-center">
            <p class="text-lg">У вас ещё нет деревьев. CF-дерево создаётся автоматически при первом входе.</p>
        </div>
        {% endif %}
    </div>

    {# --- Блок покупки TON-дерева (только если у пользователя нет TON-дерева) --- #}
    {% if ton_trees|length == 0 %}
    <div class="mt-8 text-center">
        <form action="{% url 'shop:buy_ton_tree' %}" method="post" class="inline-block">
            {% csrf_token %}
            <button type="submit"
                    class="bg-blue-500 text-white py-3 px-6 rounded-full font-semibold hover:bg-blue-600 transition">
                Купить TON-дерево за 1 TON
            </button>
        </form>
    </div>
    {% else %}
    <div class="mt-8 text-center text-gray-300">
        У вас уже есть TON-дерево. Перейдите в раздел P2P или управляйте существующим деревом.
    </div>
    {% endif %}
</div>
{% endblock %}
