{% extends 'base.html' %}

{% block title %}Oxiri P2P – Дерево{% endblock %}

{% block content %}
<div class="py-6 max-w-3xl mx-auto">

  <!-- Навигация «назад» и заголовок -->
  <div class="flex items-center mb-6">
    <a href="/" class="mr-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </a>
    <h1 class="text-xl font-bold text-white">
      {% if tree.type == 'CF' %}
        CF Дерево
      {% else %}
        TON Дерево
      {% endif %}
    </h1>
  </div>

  <!-- Основная карточка с информацией о дереве -->
  <div class="card p-4 mb-6 bg-primary/30 text-white">

    <!-- Визуальное представление (анимация + изображение уровня) -->
    <div class="tree-container mb-4">
      <img
        src="/static/images/tree_{{ tree.level }}.png"
        alt="{{ tree.type }} Tree"
        class="tree-image animate-float tree-{{ tree.type|lower }}"
      >
    </div>

    <!-- Данные о дереве в виде сетки -->
    <div class="grid grid-cols-2 gap-3 mb-4 text-white">
      <div class="bg-primary/20 p-3 rounded-lg">
        <div class="text-xs opacity-70">Уровень:</div>
        <div class="font-semibold">{{ tree.level }}</div>
      </div>
      <div class="bg-primary/20 p-3 rounded-lg">
        <div class="text-xs opacity-70">Доход в час:</div>
        <div class="font-semibold">{{ tree.income_per_hour }} {{ tree.type }}/час</div>
      </div>

      {% if tree.type == 'CF' %}
      <div class="bg-primary/20 p-3 rounded-lg">
        <div class="text-xs opacity-70">Веток собрано:</div>
        <div class="font-semibold">
          {{ tree.branches_collected }} /
          {% if tree.level == 1 %}5
          {% elif tree.level == 2 %}12
          {% elif tree.level == 3 %}30
          {% elif tree.level == 4 %}75
          {% else %}Max
          {% endif %}
        </div>
      </div>
      {% endif %}

      <div class="bg-primary/20 p-3 rounded-lg">
        <div class="text-xs opacity-70">Последний полив:</div>
        <div class="font-semibold">
          {% if tree.last_watered %}
            {{ tree.last_watered|date:"d.m.Y H:i" }}
          {% else %}
            Никого
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Блок индикатора уровня воды (для CF и TON одинаково) -->
    <div class="mb-4">
      <div class="flex justify-between text-xs text-white mb-1">
        <span>Вода</span>
        <span>{{ tree.water_level }}%</span>
      </div>
      <div class="bg-primary/20 h-2 rounded-full overflow-hidden">
        <div class="h-full bg-secondary" style="width: {{ tree.water_level }}%;"></div>
      </div>
    </div>

    <!-- Кнопка «Полить» (с AJAX) -->
    <div class="grid grid-cols-1 gap-3">
      <button
        id="water-button"
        data-tree-id="{{ tree.id }}"
        class="water-button bg-secondary hover:bg-secondary/80 transition text-center py-3 rounded-lg font-semibold"
        {% if is_watered %}disabled{% endif %}
      >
        {% if is_watered %}Уже полито{% else %}Полить{% endif %}
        {% if tree.type == 'CF' %} ({{ tree.water_cost }} CF){% endif %}
      </button>

      <div id="water-result" class="tree-info bg-primary/20 p-3 rounded-lg text-center text-sm text-white"></div>
    </div>

  </div>


  {# --- Блок «Автоматический полив» (только CF) --- #}
  {% if tree.type == 'CF' %}
  <div class="card p-4 mb-6 bg-primary/30 text-white">
    <h2 class="text-lg font-semibold mb-3 text-white">Автоматический полив</h2>

    {% if tree.auto_water_enabled %}
    <div class="bg-primary/20 p-3 rounded-lg mb-4 flex justify-between items-center">
      <div>
        <div class="text-sm">Автополив активен</div>
        <div class="text-xs opacity-70">Осталось: {{ tree.auto_water_remaining }} дн.</div>
      </div>
      <span class="status-indicator status-active"></span>
    </div>
    {% else %}
    <div class="bg-primary/20 p-3 rounded-lg mb-4 flex justify-between items-center">
      <div>
        <div class="text-sm">Автополив не активен</div>
        <div class="text-xs opacity-70">Активируйте для автоматического полива</div>
      </div>
      <span class="status-indicator status-inactive"></span>
    </div>
    {% endif %}

    <div class="grid grid-cols-3 gap-2">
      <a href="/tree/{{ tree.id }}/auto/3/" class="bg-primary/40 hover:bg-primary/60 transition text-center py-2 rounded-lg text-sm">
        3 дн.<br><span class="text-xs opacity-70">15 CF</span>
      </a>
      <a href="/tree/{{ tree.id }}/auto/7/" class="bg-primary/40 hover:bg-primary/60 transition text-center py-2 rounded-lg text-sm">
        7 дн.<br><span class="text-xs opacity-70">30 CF</span>
      </a>
      <a href="/tree/{{ tree.id }}/auto/30/" class="bg-primary/40 hover:bg-primary/60 transition text-center py-2 rounded-lg text-sm">
        30 дн.<br><span class="text-xs opacity-70">100 CF</span>
      </a>
    </div>
  </div>
  {% endif %}


  {# --- Блок «Удобрение» (только CF) --- #}
  {% if tree.type == 'CF' %}
  <div class="card p-4 mb-6 bg-primary/30 text-white">
    <h2 class="text-lg font-semibold mb-3 text-white">Удобрение</h2>

    {% if tree.fertilizer_active %}
    <div class="bg-primary/20 p-3 rounded-lg mb-4 flex justify-between items-center">
      <div>
        <div class="text-sm">Удобрение активно</div>
        <div class="text-xs opacity-70">Осталось: {{ tree.fertilizer_remaining }} ч.</div>
      </div>
      <span class="status-indicator status-active"></span>
    </div>
    {% else %}
    <div class="bg-primary/20 p-3 rounded-lg mb-4 flex justify-between items-center">
      <div>
        <div class="text-sm">Удобрение не активно</div>
        <div class="text-xs opacity-70">Удобрение увеличивает доход ×1.5</div>
      </div>
      <span class="status-indicator status-inactive"></span>
    </div>
    {% endif %}

    <div class="grid grid-cols-3 gap-2">
      <a href="/tree/{{ tree.id }}/fertilize/6/" class="bg-primary/40 hover:bg-primary/60 transition text-center py-2 rounded-lg text-sm">
        6 ч<br><span class="text-xs opacity-70">10 CF</span>
      </a>
      <a href="/tree/{{ tree.id }}/fertilize/12/" class="bg-primary/40 hover:bg-primary/60 transition text-center py-2 rounded-lg text-sm">
        12 ч<br><span class="text-xs opacity-70">18 CF</span>
      </a>
      <a href="/tree/{{ tree.id }}/fertilize/24/" class="bg-primary/40 hover:bg-primary/60 transition text-center py-2 rounded-lg text-sm">
        24 ч<br><span class="text-xs opacity-70">30 CF</span>
      </a>
    </div>
  </div>
  {% endif %}


  {# --- Блок «Повышение уровня» (только CF, если level < 5) --- #}
  {% if tree.type == 'CF' and tree.level < 5 %}
  <div class="card p-4 mb-6 bg-primary/30 text-white">
    <h2 class="text-lg font-semibold mb-3 text-white">Повышение уровня</h2>

    <div class="bg-primary/20 p-3 rounded-lg mb-4">
      <div class="flex justify-between">
        <div class="text-sm">Прогресс улучшения:</div>
        <div class="text-sm font-semibold">
          {{ tree.branches_collected }} /
          {% if tree.level == 1 %}5
          {% elif tree.level == 2 %}12
          {% elif tree.level == 3 %}30
          {% elif tree.level == 4 %}75
          {% endif %}
        </div>
      </div>
      <div class="mt-2 bg-primary/20 h-2 rounded-full overflow-hidden">
        <div
          class="h-full bg-accent"
          style="width:
          {% if tree.level == 1 %}
            {% widthratio tree.branches_collected 5 100 %}
          {% elif tree.level == 2 %}
            {% widthratio tree.branches_collected 12 100 %}
          {% elif tree.level == 3 %}
            {% widthratio tree.branches_collected 30 100 %}
          {% elif tree.level == 4 %}
            {% widthratio tree.branches_collected 75 100 %}
          {% endif %}%;
          ">
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-2">
      <a href="/tree/{{ tree.id }}/collect_branch/" class="bg-accent text-dark font-semibold py-3 rounded-lg text-center">
        Собрать ветку ({{ tree.branch_cost }} CF)
      </a>
    </div>
  </div>
  {% endif %}


  {# --- Блок «Раздача TON» (только для TON-дерева) --- #}
  {% if tree.type == 'TON' %}
  <div class="card p-4 mb-6 bg-blue-500/20 text-white rounded-lg">
    <h2 class="text-lg font-semibold mb-3">Раздача TON</h2>

    {% if active_distribution and participants_count %}
    <div class="bg-blue-400/20 p-3 rounded-lg mb-4">
      <p><strong>Раздача №{{ active_distribution.id }} (активна):</strong></p>
      <p>Всего TON: <span class="font-semibold">{{ active_distribution.total_amount }}</span></p>
      <p>Длительность: <span class="font-semibold">{{ active_distribution.duration_hours }} ч</span></p>
      <p>Участников: <span class="font-semibold">{{ participants_count }}</span></p>
      <p>Каждый получает:
        <span class="font-semibold">{{ ton_per_hour|floatformat:8 }}</span> TON/ч,
        <span class="font-semibold">{{ ton_for_5h|floatformat:8 }}</span> TON за 5 ч
      </p>
    </div>
    {% else %}
    <p class="text-gray-300 mb-4">В данный момент нет активной раздачи TON.</p>
    {% endif %}

    <div class="grid grid-cols-1 gap-2">
      <button
        id="water-ton-button"
        data-tree-id="{{ tree.id }}"
        class="bg-blue-300 hover:bg-blue-400 transition text-dark font-semibold py-3 rounded-lg text-center"
        {% if is_watered and not active_distribution %}disabled{% endif %}

      >
        Полить для TON
      </button>
      <div id="water-ton-result" class="tree-info bg-blue-400/20 p-3 rounded-lg text-center text-sm text-white"></div>
    </div>
  </div>
  {% endif %}


  {# --- История активности дерева (лог) --- #}
  <div class="card p-4 mb-6 bg-primary/30 text-white">
    <h2 class="text-lg font-semibold mb-3 text-white">История активности</h2>

    {% if tree_logs %}
    <div class="space-y-2">
      {% for log in tree_logs %}
      <div class="bg-primary/20 p-3 rounded-lg flex justify-between items-center">
        <div>
          <div class="text-sm">{{ log.action }}</div>
          <div class="text-xs opacity-70">{{ log.created_at|date:"d.m.Y H:i" }}</div>
        </div>
        <div class="text-sm font-semibold">
          {% if log.reward %}
            +{{ log.reward }} {{ tree.type }}
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-4 opacity-70">
      Пока нет записей активности
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}


{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 1) Анимация прогресс‐баров при загрузке
    const progressBars = document.querySelectorAll('.bg-secondary, .bg-accent');
    progressBars.forEach(bar => {
      const w = bar.style.width;
      bar.style.width = '0';
      setTimeout(() => {
        bar.style.transition = 'width 1s ease-in-out';
        bar.style.width = w;
      }, 100);
    });

    // 2) AJAX для полива CF-дерева
    const cfButton = document.getElementById('water-button');
    if (cfButton) {
      cfButton.addEventListener('click', function() {
        const treeId = this.getAttribute('data-tree-id');
        this.disabled = true;
        const resultDiv = document.getElementById('water-result');
        resultDiv.textContent = 'Отправляем запрос…';

        fetch(`/tree/${treeId}/water/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            let msg = 'Успешно полито.';
            if (data.branch_dropped) {
              msg += ' Ветка найдена!';
            }
            if (data.amount_cf) {
              msg += ` +${data.amount_cf.toFixed(2)} CF.`;
            }
            resultDiv.textContent = msg;
          } else {
            resultDiv.textContent = 'Ошибка: ' + (data.message || data.error);
            cfButton.disabled = false;
          }
        })
        .catch(err => {
          console.error(err);
          resultDiv.textContent = 'Ошибка соединения.';
          cfButton.disabled = false;
        });
      });
    }

    // 3) AJAX для полива TON-дерева
    const tonButton = document.getElementById('water-ton-button');
    if (tonButton) {
      tonButton.addEventListener('click', function() {
        const treeId = this.getAttribute('data-tree-id');
        this.disabled = true;
        const resultDiv = document.getElementById('water-ton-result');
        resultDiv.textContent = 'Отправляем запрос…';

        fetch(`/tree/${treeId}/water/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            let msg = 'Успешно полито.';
            if (data.branch_dropped) {
              msg += ' Ветка найдена!';
            }
            if (data.amount_ton) {
              msg += ` +${data.amount_ton.toFixed(8)} TON.`;
            } else {
              msg += ' Нет активной раздачи TON.';
            }
            resultDiv.textContent = msg;
          } else {
            resultDiv.textContent = 'Ошибка: ' + (data.message || data.error);
            tonButton.disabled = false;
          }
        })
        .catch(err => {
          console.error(err);
          resultDiv.textContent = 'Ошибка соединения.';
          tonButton.disabled = false;
        });
      });
    }
  });
</script>
{% endblock %}
