{% extends 'base.html' %}
{% load static %}

{% block title %}Oxiri P2P – Дерево{% endblock %}

{% block content %}
<div class="py-6 max-w-3xl mx-auto">

  <!-- Навигация «назад» и заголовок -->
  <div class="flex items-center mb-6">
    <a href="/" class="mr-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </a>
    <h1 class="text-xl font-bold text-white">
      {% if tree.type == 'CF' %}FLORA Дерево{% else %}TON Дерево{% endif %}
    </h1>
  </div>
{% load humanize %}

<!-- Суммы сверху -->
<div class="mt-6 flex flex-col items-center space-y-3">
    <div class="w-64 h-12 flex items-center justify-center rounded-xl font-semibold text-base shadow"
         style="background: #160D76;">
        Создано CF: <span id="created-cf" class="ml-2">{{ total_created_cf|intcomma }}</span>
    </div>
    <div class="w-64 h-12 flex items-center justify-center rounded-xl font-semibold text-base shadow"
         style="background: #160D76;">
        Выращено: <span id="all-cf-grown" class="ml-2">{{ all_cf_grown|floatformat:0|intcomma }}</span>
    </div>
    <div class="w-64 h-12 flex items-center justify-center rounded-xl font-semibold text-base shadow"
         style="background: #160D76;">
        Выращено: <span id="user-cf-grown" class="ml-2">{{ user_cf_grown|floatformat:0|intcomma }}</span> CF
    </div>
</div>


<!-- Основная карточка дерева -->
<div class="relative rounded-2xl shadow-2xl overflow-hidden my-10"
     style="background: url('{% static 'images/bg.png' %}') center/cover, linear-gradient(135deg, #6BC2FF 60%, #E0ECFF 100%); min-height: 270px;">

    <div class="absolute inset-0 bg-black/10"></div>
    <div class="relative z-10 flex flex-col items-center py-6 px-6">

        <!-- Картинка дерева -->
        <img
          src="/static/images/tree_{{ tree.level }}.png"
          alt="{{ tree.type }} Tree"
          class="mb-4 animate-float"
          style="height: 140px; max-width: 90vw; filter: drop-shadow(0 6px 18px #58a4ff99);"
        >

        <!-- Красивая синяя подпись -->
        <span class="text-blue-800 bg-white/80 rounded-lg px-3 py-1 text-base font-bold mb-5 shadow">
            {% if tree.type == 'CF' %}Дерево: FLORA{% else %}Дерево: TON{% endif %}
        </span>

        <!-- Данные о дереве -->
        <div class="grid grid-cols-2 gap-5 mb-4 w-full max-w-md text-white">
          <div class="bg-blue-900/20 p-4 rounded-xl text-center shadow">
            <div class="text-xs opacity-70">Уровень:</div>
            <div class="font-semibold text-lg" id="tree-level">{{ tree.level }}</div>
          </div>
          <div class="bg-blue-900/20 p-4 rounded-xl text-center shadow">
            <div class="text-xs opacity-70">Доход в час:</div>
            <div class="font-semibold text-lg" id="tree-income">{{ tree.income_per_hour }} {{ tree.type }}/ч</div>
          </div>
          {% if tree.type == 'CF' %}
          <div class="bg-blue-900/20 p-4 rounded-xl text-center shadow col-span-2 sm:col-span-1">
            <div class="text-xs opacity-70">Веток собрано:</div>
            <div class="font-semibold text-lg" id="tree-branches">
              {{ tree.branches_collected }} /
              {% if tree.level == 1 %}5
              {% elif tree.level == 2 %}12
              {% elif tree.level == 3 %}30
              {% elif tree.level == 4 %}75
              {% else %}Max
              {% endif %}
            </div>
          </div>
          {% endif %}
          <div class="bg-blue-900/20 p-4 rounded-xl text-center shadow col-span-2 sm:col-span-1">
            <div class="text-xs opacity-70">Последний полив:</div>
            <div class="font-semibold text-lg tree-last-watered" id="tree-last-watered">
              {% if tree.last_watered %}
                {{ tree.last_watered|date:"d.m.Y H:i" }}
              {% else %}
                Никогда
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Накопленный доход -->
        <div class="flex justify-between items-center w-full max-w-md mb-2 text-white">
          <span class="text-base">Можно собрать:</span>
          <span class="text-lg font-semibold">
            <span id="pending-income">{{ pending_income }} CF</span>
            <button
              id="collect-income-btn"
              data-tree-id="{{ tree.id }}"
              class="ml-2 px-4 py-2 bg-accent text-dark rounded-full hover:bg-accent/80 font-bold text-base shadow"
              {% if pending_income|floatformat:4 == '0.0000' %}disabled{% endif %}
            >Собрать</button>
          </span>
        </div>
        <div id="collect-income-result" class="tree-info bg-blue-900/20 p-2 rounded-lg text-center text-xs text-white mb-2"></div>

        <!-- Прогресс-бар воды -->
        <div class="mb-4 w-full max-w-md">
          <div class="flex justify-between text-xs text-white mb-1">
            <span>Вода</span>
            <span id="water-percent">{{ water_percent }}%</span>
          </div>
          <div class="bg-blue-900/20 h-3 rounded-full overflow-hidden shadow">
            <div id="water-bar" class="h-full bg-accent transition-all duration-700"
                 style="width: {{ water_percent }}%;"></div>
          </div>
        </div>

        <!-- Кнопка полива -->
        <div class="grid grid-cols-1 gap-3 w-full max-w-md">
          <button
            id="water-button"
            data-tree-id="{{ tree.id }}"
            class="water-button bg-blue-500 hover:bg-blue-600 transition text-center py-3 rounded-full font-bold text-lg text-white shadow"
            {% if is_watered %}disabled{% endif %}
          >
            {% if is_watered %}Уже полито{% else %}Полить{% endif %}
          </button>
{#          <div id="water-result" class="tree-info bg-blue-900/20 p-3 rounded-lg text-center text-sm text-white"></div>#}
        </div>
    <!-- Купленные предметы и эффекты -->
        <div class="w-full max-w-md mt-5">
            <h3 class="text-base font-bold text-white mb-3">Купленные предметы:</h3>
            <ul>
                {% if tree.auto_water_until and tree.auto_water_until > now %}
                    <li class="bg-white/80 text-green-800 rounded px-3 py-1 mb-1 font-semibold shadow">
                      <b>Автополив</b> (ещё {{ tree.auto_water_until|timeuntil }})
                    </li>
                {% endif %}
                {% if tree.fertilized_until and tree.fertilized_until > now %}
                    <li class="bg-white/80 text-green-800 rounded px-3 py-1 mb-1 font-semibold shadow">
                      <b>Удобрение</b> (доход ×2, ещё {{ tree.fertilized_until|timeuntil }})
                    </li>
                {% endif %}
                {% for purchase in user.purchases.all %}
                    {% if purchase.item.type == 'fertilizer' or purchase.item.type == 'auto_water' %}
                      <li class="bg-white/90 text-blue-800 rounded px-3 py-1 mb-2 flex items-center justify-between shadow">
                        <span>
                            {{ purchase.item.get_type_display }}
                            {% if purchase.item.duration %} ({{ purchase.item.duration }} ч.){% endif %}
                        </span>
                        <form method="post" action="{% url 'shop:use_shop_item' purchase.id %}" style="display:inline;">
                          {% csrf_token %}
                          <button type="submit"
                            class="ml-3 px-3 py-1 rounded bg-blue-500 text-white font-bold hover:bg-blue-600 transition"
                            {% if purchase.item.type == 'fertilizer' and fertilizer_active or purchase.item.type == 'auto_water' and auto_water_active %}
                                disabled
                            {% endif %}
                          >Использовать</button>
                        </form>
                      </li>
                    {% endif %}
                {% empty %}
                    <li class="bg-white/70 text-blue-900 rounded px-3 py-1 mb-1 shadow">Нет предметов для использования.</li>
                {% endfor %}
            </ul>
            {% if not auto_water_active and not fertilizer_active and not user.purchases.all %}
              <div class="mt-3 text-center">
                <a href="{% url 'shop:shop' %}" class="inline-block px-6 py-2 bg-accent text-white rounded-full font-semibold shadow">
                  Перейти в магазин
                </a>
              </div>
            {% endif %}
        </div>

        {# --- Повышение уровня (если нужно) --- #}
        {% if tree.type == 'CF' and tree.level < 5 %}
        <div class="w-full max-w-md mt-6">
          <div class="bg-white/80 rounded-2xl shadow-lg px-4 py-4">
            <h2 class="text-lg font-semibold mb-3 text-blue-900">Повышение уровня</h2>
            <div class="bg-white/50 p-3 rounded-lg mb-4 shadow-sm">
              <div class="flex justify-between">
                <div class="text-sm text-blue-900 opacity-80">Прогресс улучшения:</div>
                <div class="text-sm font-semibold text-blue-900" id="upgrade-progress">
                  {{ tree.branches_collected }} /
                  {% if tree.level == 1 %}5
                  {% elif tree.level == 2 %}12
                  {% elif tree.level == 3 %}30
                  {% elif tree.level == 4 %}75
                  {% endif %}
                </div>
              </div>
              <div class="mt-2 bg-blue-900/10 h-2 rounded-full overflow-hidden">
                <div
                  id="upgrade-bar"
                  class="h-full bg-accent"
                  style="width:
                  {% if tree.level == 1 %}
                    {% widthratio tree.branches_collected 5 100 %}
                  {% elif tree.level == 2 %}
                    {% widthratio tree.branches_collected 12 100 %}
                  {% elif tree.level == 3 %}
                    {% widthratio tree.branches_collected 30 100 %}
                  {% elif tree.level == 4 %}
                    {% widthratio tree.branches_collected 75 100 %}
                  {% endif %}%;">
                </div>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-2">
              {% if can_upgrade %}
              <button
                id="upgrade-button"
                data-tree-id="{{ tree.id }}"
                class="bg-green-500 hover:bg-green-600 transition text-center py-3 rounded-full text-white font-semibold shadow"
              >
                Улучшить уровень
              </button>
              {% else %}
              <button
                class="bg-gray-400 text-center py-3 rounded-full text-white font-semibold opacity-60 cursor-not-allowed"
                disabled
              >
                Недостаточно веток
              </button>
              {% endif %}
              <div id="upgrade-result" class="tree-info bg-blue-900/10 p-3 rounded-lg text-center text-sm text-blue-900"></div>
            </div>
          </div>
        </div>
        {% endif %}
    </div>
</div>
      </div>
  </div>


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Прогресс-бар анимация
  const bar = document.getElementById('water-bar');
  if (bar) {
    const w = bar.style.width;
    bar.style.width = '0';
    setTimeout(() => {
      bar.style.transition = 'width 1s ease-in-out';
      bar.style.width = w;
    }, 100);
  }

  // --- AJAX для полива ---
  const cfButton = document.getElementById('water-button');
  if (cfButton) {
    cfButton.addEventListener('click', function() {
      const treeId = this.getAttribute('data-tree-id');
      this.disabled = true;
      const resultDiv = document.getElementById('water-result');
      resultDiv.textContent = 'Отправляем запрос…';

      fetch(`/tree/${treeId}/water/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          let msg = 'Успешно полито.';
          // Если ветка выпала — сразу обновить ветки
          if (typeof data.branches_collected !== 'undefined') {
            document.getElementById('tree-branches').textContent =
              data.branches_collected + ' / ' +
              document.getElementById('tree-branches').textContent.split('/')[1].trim();
            msg += data.branch_dropped ? ' Ветка найдена!' : '';
          }
          if (typeof data.amount_cf !== 'undefined') {
            msg += ` +${parseFloat(data.amount_cf).toFixed(2)} CF.`;
          }
          // Обновить последний полив
          if (data.last_watered) {
            document.getElementById('tree-last-watered').textContent = data.last_watered;
          }
          // Обновить доход "Можно собрать"
          if (typeof data.pending_income !== 'undefined') {
            document.getElementById('pending-income').textContent = parseFloat(data.pending_income).toFixed(4) + ' CF';
            // и разблокировать кнопку "Собрать" если доход снова > 0
            if (parseFloat(data.pending_income) > 0) {
              document.getElementById('collect-income-btn').disabled = false;
            }
          }
          // Обновить воду
          if (typeof data.water_percent !== 'undefined') {
            document.getElementById('water-percent').textContent = data.water_percent + '%';
            document.getElementById('water-bar').style.width = data.water_percent + '%';
          }
          resultDiv.textContent = msg;
        } else {
          resultDiv.textContent = 'Ошибка: ' + (data.message || data.error);
          cfButton.disabled = false;
        }
      })
      .catch(err => {
        console.error(err);
        resultDiv.textContent = 'Ошибка соединения.';
        cfButton.disabled = false;
      });
    });
  }

  // --- AJAX для апгрейда дерева ---
  const upgradeButton = document.getElementById('upgrade-button');
  if (upgradeButton) {
    upgradeButton.addEventListener('click', function() {
      const treeId = this.getAttribute('data-tree-id');
      this.disabled = true;
      const resultDiv = document.getElementById('upgrade-result');
      resultDiv.textContent = 'Обновление...';

      fetch(`/tree/${treeId}/upgrade/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          resultDiv.textContent = data.message;
          location.reload(); // на апгрейд пока проще перезагрузить
        } else {
          resultDiv.textContent = 'Ошибка: ' + (data.message || data.error);
          upgradeButton.disabled = false;
        }
      })
      .catch(err => {
        console.error(err);
        resultDiv.textContent = 'Ошибка соединения.';
        upgradeButton.disabled = false;
      });
    });
  }

  // --- Сбор дохода (AJAX) ---
  const collectBtn = document.getElementById('collect-income-btn');
  if (collectBtn) {
    collectBtn.addEventListener('click', function() {
      const treeId = this.getAttribute('data-tree-id');
      this.disabled = true;
      const resultDiv = document.getElementById('collect-income-result');
      resultDiv.textContent = 'Собираем...';

      fetch(`/tree/${treeId}/collect_income/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          // Обновить баланс пользователя (если есть блок)
          if (data.new_balance_cf !== undefined) {
            // document.getElementById('user-cf-balance').textContent = data.new_balance_cf + ' CF';
          }
          // Обновить счетчик дохода
          document.getElementById('pending-income').textContent = '0.0000 CF';
          resultDiv.textContent = 'Доход успешно собран!';
        } else {
          resultDiv.textContent = 'Ошибка: ' + (data.message || data.error);
          collectBtn.disabled = false;
        }
      })
      .catch(err => {
        console.error(err);
        resultDiv.textContent = 'Ошибка соединения.';
        collectBtn.disabled = false;
      });
    });
  }
});
</script>
{% endblock %}
