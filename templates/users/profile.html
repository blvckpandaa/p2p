{% extends 'base.html' %}
{% load static %}

{% block title %}Мой профиль{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modern-profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <div class="profile-header-content">
            <div class="profile-avatar">
                {% if photo_url %}
                    <img src="{{ photo_url }}" alt="{{ user.get_full_name }}">
                {% else %}
                    <div class="profile-avatar-placeholder">
                        {{ user.first_name|first }}{% if user.last_name %}{{ user.last_name|first }}{% endif %}
                    </div>
                {% endif %}
            </div>
            
            <div class="profile-info">
                <h1 class="profile-name">{{ user.get_full_name }}</h1>
                {% if user.username %}
                    <p class="profile-username">@{{ user.username }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="balance-card">
        <h2 class="balance-card-title"><i class="fas fa-wallet"></i> Ваш баланс</h2>
        <div class="balance-item">
            <div class="balance-token">
                <div class="token-icon cf">CF</div>
                <div class="token-info">
                    <span class="token-name">CF Токены</span>
                    <span class="token-description">Основная игровая валюта</span>
                </div>
            </div>
            <div class="token-amount">{{ cf_balance|floatformat:2 }}</div>
        </div>
        <div class="balance-item">
            <div class="balance-token">
                <div class="token-icon ton">TON</div>
                <div class="token-info">
                    <span class="token-name">TON Токены</span>
                    <span class="token-description">Торговая валюта</span>
                </div>
            </div>
            <div class="token-amount">{{ ton_balance|floatformat:8 }}</div>
        </div>
    </div>

    <div class="trees-section">
        <h2 class="balance-card-title"><i class="fas fa-tree"></i> Ваши деревья</h2>
        {% for tree in trees %}
        <div class="tree-item">
            <div class="tree-info">
                <div class="tree-icon {{ tree.type|lower }}">
                    <span>{{ tree.type }}</span>
                </div>
                <div class="tree-details">
                    <span class="tree-type">{{ tree.get_type_display }}</span>
                    <span class="tree-level">Уровень {{ tree.level }}</span>
                </div>
            </div>
            <div class="tree-income">
                <i class="fas fa-coins"></i> {{ tree.income_per_hour|floatformat:2 }}/час
            </div>
        </div>
        {% empty %}
        <p class="text-center" style="color: rgba(255, 255, 255, 0.6);">У вас пока нет деревьев</p>
        {% endfor %}
    </div>

    <div class="referral-section">
        <div class="referral-card">
            <h2 class="balance-card-title"><i class="fas fa-users"></i> Реферальная программа</h2>
            <p>Пригласите друзей и получите бонусы!</p>
            
            <div class="referral-code">
                {{ referral_code }}
            </div>
            
            <div class="referral-stats">
                <div class="stat-card">
                    <div class="stat-label">Приглашено друзей</div>
                    <div class="stat-value">{{ referral_count }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Получено токенов</div>
                    <div class="stat-value">{{ referral_rewards }} CF</div>
                </div>
            </div>
            
            <button id="copy-btn" class="copy-btn">
                <i class="fas fa-share-alt"></i> Поделиться реферальной ссылкой
            </button>
            
            <div class="referral-link" id="ref-link">
                https://t.me/p2pFloriya_bot?start={{ referral_code }}
            </div>
            {% if referrals_info %}
                <div class="referrals-list">
                    <h3 class="referrals-list-title">Ваши приглашённые:</h3>
                    <ul>
                        {% for ref in referrals_info %}
                            <li class="referral-item">
                                <div class="referral-user">
                                    <span class="referral-username">@{{ ref.username }}</span>
                                    <span class="referral-name">{{ ref.first_name }} {{ ref.last_name }}</span>
                                </div>
                                <div class="referral-date">С: {{ ref.joined|date:"d.m.Y" }}</div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <div class="text-center" style="color: rgba(255, 255, 255, 0.6); margin-top: 1rem;">У вас пока нет рефералов</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const copyBtn = document.getElementById('copy-btn');
        const refLink = document.getElementById('ref-link');
        if (copyBtn && refLink) {
            copyBtn.addEventListener('click', function() {
                const tempInput = document.createElement('input');
                tempInput.value = refLink.textContent.trim();
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Скопировано!';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            });
        }
    });
</script>
{% endblock %}
